resampling_results = rr_qda,
final_model_object = glrn,
# Correct way to get the nested QDA model
native_model = glrn$model$classif.qda$model
)
}
model_qda(task, filter_nfeat = 3)
results.auc <- readRDS("data/results/results auc.rds")
results.auc$performance
model_qda <- function(task, resampling_folds = 5,
measures = c("classif.acc", "classif.auc", "classif.ce", "classif.sensitivity", "classif.specificity"),
filter = "auc", filter_nfeat = 5, pca = FALSE, pca_rank = NULL) {
# 1. Define mandatory start of the pipeline
pipeline <- list(
po("scale"),
po("classbalancing", adjust = "minor", reference = "major", id = "balance"),
po("filter", filter = flt(filter), filter.nfeat = filter_nfeat)
)
# 2. Conditionally add PCA
if (pca) {
p_rank <- if (is.null(pca_rank)) min(task$ncol, 5) else pca_rank
pipeline <- c(pipeline, po("pca", rank. = p_rank))
}
# 3. Add the Learner
qda_lrn <- lrn("classif.qda", predict_type = "prob")
pipeline <- c(pipeline, qda_lrn)
# 4. This connects everything in the list regardless of length
my_graph <- Reduce(`%>>%`, pipeline)
# Visualize for debugging
my_graph$plot()
glrn <- GraphLearner$new(my_graph)
# 5. Resampling (using the function argument for folds)
set.seed(123)
rr_qda <- mlr3::resample(task, glrn, rsmp("cv", folds = resampling_folds), store_models = TRUE)
# Final model
glrn$train(task)
# 6. Safe Output Extraction
list(
performance = rr_qda$aggregate(msrs(measures)),
confusion_matrix = rr_qda$prediction()$confusion,
resampling_results = rr_qda,
final_model_object = glrn,
native_model = glrn$model$classif.qda$model
)
}
model_qda(task, filter_nfeat = 3)
glrn$graph
glrn$graph_model
glrn$model$classif.qda$model
library(mlr3)
library(mlr3pipelines)
library(mlr3filters)
library(mlr3learners)
data.analysis <- readRDS("data/intermediate/data analysis.rds")
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster <- bind_cols(data.cluster, class = data.analysis$class)
task <- TaskClassif$new(
id = "Classification original data",
backend = data.cluster,
target = "class",
positive = "fresh"
)
task$col_roles$stratum <- "class"
# 2. Define the SAME folds for everyone
same_folds = rsmp("cv", folds = 5)
resampling.instance <- same_folds$instantiate(task)
model_qda <- function(task, resampling_folds = 5,
measures = c("classif.acc", "classif.auc", "classif.ce", "classif.sensitivity", "classif.specificity"),
filter = "auc", filter_nfeat = 5, pca = FALSE, pca_rank = NULL) {
# 1. Define mandatory start of the pipeline
pipeline <- list(
po("scale"),
po("classbalancing", adjust = "minor", reference = "major", id = "balance"),
po("filter", filter = flt(filter), filter.nfeat = filter_nfeat)
)
# 2. Conditionally add PCA
if (pca) {
p_rank <- if (is.null(pca_rank)) min(task$ncol, 5) else pca_rank
pipeline <- c(pipeline, po("pca", rank. = p_rank))
}
# 3. Add the Learner
qda_lrn <- lrn("classif.qda", predict_type = "prob")
pipeline <- c(pipeline, qda_lrn)
# 4. This connects everything in the list regardless of length
my_graph <- Reduce(`%>>%`, pipeline)
# Visualize for debugging
my_graph$plot()
glrn <- GraphLearner$new(my_graph)
# 5. Resampling (using the function argument for folds)
set.seed(123)
rr_qda <- mlr3::resample(task, glrn, rsmp("cv", folds = resampling_folds), store_models = TRUE)
# Final model
glrn$train(task)
# 6. Safe Output Extraction
list(
performance = rr_qda$aggregate(msrs(measures)),
confusion_matrix = rr_qda$prediction()$confusion,
resampling_results = rr_qda,
final_model_object = glrn,
model = glrn
)
}
model_qda(task, resampling.instance)
model_qda <- function(task, resampling_folds = 5, resampling_instance = NULL
measures = c("classif.acc", "classif.auc", "classif.ce", "classif.sensitivity", "classif.specificity"),
model_qda <- function(task, resampling_folds = 5, resampling_instance = NULL,
measures = c("classif.acc", "classif.auc", "classif.ce", "classif.sensitivity", "classif.specificity"),
filter = "auc", filter_nfeat = 5, pca = FALSE, pca_rank = NULL) {
# 1. Define mandatory start of the pipeline
pipeline <- list(
po("scale"),
po("classbalancing", adjust = "minor", reference = "major", id = "balance"),
po("filter", filter = flt(filter), filter.nfeat = filter_nfeat)
)
# 2. Conditionally add PCA
if (pca) {
p_rank <- if (is.null(pca_rank)) min(task$ncol, 5) else pca_rank
pipeline <- c(pipeline, po("pca", rank. = p_rank))
}
# 3. Add the Learner
qda_lrn <- lrn("classif.qda", predict_type = "prob")
pipeline <- c(pipeline, qda_lrn)
# 4. This connects everything in the list regardless of length
my_graph <- Reduce(`%>>%`, pipeline)
# Visualize for debugging
my_graph$plot()
glrn <- GraphLearner$new(my_graph)
# 5. Resampling (using the function argument for folds)
set.seed(123)
if (is.null(resampling_instance)) {
rr_qda <- mlr3::resample(task, glrn, rsmp("cv", folds = resampling_folds), store_models = TRUE)
}
rr_qda <- mlr3::resample(task, glrn, resampling_instance, store_models = TRUE)
# Final model
glrn$train(task)
# 6. Safe Output Extraction
list(
performance = rr_qda$aggregate(msrs(measures)),
confusion_matrix = rr_qda$prediction()$confusion,
resampling_results = rr_qda,
final_model_object = glrn,
model = glrn
)
}
library(mlr3)
library(mlr3pipelines)
library(mlr3filters)
library(mlr3learners)
data.analysis <- readRDS("data/intermediate/data analysis.rds")
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster <- bind_cols(data.cluster, class = data.analysis$class)
task <- TaskClassif$new(
id = "Classification original data",
backend = data.cluster,
target = "class",
positive = "fresh"
)
task$col_roles$stratum <- "class"
# 2. Define the SAME folds for everyone
same_folds = rsmp("cv", folds = 5)
resampling.instance <- same_folds$instantiate(task)
model_qda(task, filter_nfeat = 3, resampling_instance = resampling.instance)
lrn()
class(resampling.instance)
source("settings.R")
source("source_all.R")
if (!file.exists("data/intermediate/data analysis.rds")) {
build_data_main()
}
data.analysis <- readRDS("data/intermediate/data analysis.rds")
knitr::include_graphics("plot/densities1.png")
source("settings.R")
source("source_all.R")
if (!file.exists("data/intermediate/data analysis.rds")) {
build_data_main()
}
data.analysis <- readRDS("data/intermediate/data analysis.rds")
knitr::include_graphics("plot/densities1.png")
knitr::include_graphics("plot/densities2.png")
knitr::include_graphics("plot/imputation_7_K value.png")
data.imputed <- readRDS("data/intermediate/data imputated.rds")
cor.data <- data.analysis |> dplyr::select(!c(sample, class))
corr_Kvalue <- cor(cor.data)["K value",]
top.cor <- sort(abs(corr_Kvalue), decreasing = TRUE)
(top.cor <- head(top.cor, 10))
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster <- bind_cols(data.cluster, class = data.analysis$class)
task <- TaskClassif$new(
id = "Classification original data",
backend = data.cluster,
target = "class",
positive = "fresh"
)
task$col_roles$stratum <- "class"
methods <- c("anova", "auc", "importance", "information_gain")
lapply(methods, function(i) feature_selection(task, i))
source("~/Desktop/NIR/code/data preparation.R")
cor.data <- data.analysis |> dplyr::select(!c(sample, class))
corr_Kvalue <- cor(cor.data)["K value",]
top.cor <- sort(abs(corr_Kvalue), decreasing = TRUE)
(top.cor <- head(top.cor, 10))
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster <- bind_cols(data.cluster, class = data.analysis$class)
task <- TaskClassif$new(
id = "Classification original data",
backend = data.cluster,
target = "class",
positive = "fresh"
)
task$col_roles$stratum <- "class"
methods <- c("anova", "auc", "importance", "information_gain")
lapply(methods, function(i) feature_selection(task, i))
cor.data <- data.analysis |> dplyr::select(!c(sample, class))
corr_Kvalue <- cor(cor.data)["K value",]
top.cor <- sort(abs(corr_Kvalue), decreasing = TRUE)
(top.cor <- head(top.cor, 10))
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster <- bind_cols(data.cluster, class = data.analysis$class)
task <- TaskClassif$new(
id = "Classification original data",
backend = data.cluster,
target = "class",
positive = "fresh"
)
task$col_roles$stratum <- "class"
methods <- c("anova", "auc", "importance", "information_gain")
tab <- lapply(methods, function(i) feature_selection(task, i))
tab <- data.frame(anova = tab[[1]], auc = tab[[2]], importance = tab[[3]], information = tab[[4]])
View(tab)
head(tab)
cor.data <- data.analysis |> dplyr::select(!c(sample, class))
corr_Kvalue <- cor(cor.data)["K value",]
top.cor <- sort(abs(corr_Kvalue), decreasing = TRUE)
(top.cor <- head(top.cor, 10))
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster <- bind_cols(data.cluster, class = data.analysis$class)
task <- TaskClassif$new(
id = "Classification original data",
backend = data.cluster,
target = "class",
positive = "fresh"
)
task$col_roles$stratum <- "class"
methods <- c("anova", "auc", "importance", "information_gain")
tab <- lapply(methods, function(i) feature_selection(task, i))
as.data.frame(tab)
b <- as.data.frame(tab)
View(b)
cor.data <- data.analysis |> dplyr::select(!c(sample, class))
corr_Kvalue <- cor(cor.data)["K value",]
top.cor <- sort(abs(corr_Kvalue), decreasing = TRUE)
(top.cor <- head(top.cor, 10))
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster <- bind_cols(data.cluster, class = data.analysis$class)
task <- TaskClassif$new(
id = "Classification original data",
backend = data.cluster,
target = "class",
positive = "fresh"
)
task$col_roles$stratum <- "class"
methods <- c("anova", "auc", "importance", "information_gain")
tab <- as.data.frame(lapply(methods, function(i) feature_selection(task, i)))
colnames(tab) <- methods
head(tab)
View(tab)
cor.data <- data.analysis |> dplyr::select(!c(sample, class))
corr_Kvalue <- cor(cor.data)["K value",]
top.cor <- sort(abs(corr_Kvalue), decreasing = TRUE)
(top.cor <- head(top.cor, 10))
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster <- bind_cols(data.cluster, class = data.analysis$class)
task <- TaskClassif$new(
id = "Classification original data",
backend = data.cluster,
target = "class",
positive = "fresh"
)
task$col_roles$stratum <- "class"
methods <- c("anova", "auc", "importance", "information_gain")
tab <- as.data.frame(lapply(methods, function(i) feature_selection(task, i)))
tab$auc <- tab$auc + 0.5
cor.data <- data.analysis |> dplyr::select(!c(sample, class))
corr_Kvalue <- cor(cor.data)["K value",]
top.cor <- sort(abs(corr_Kvalue), decreasing = TRUE)
(top.cor <- head(top.cor, 10))
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster <- bind_cols(data.cluster, class = data.analysis$class)
task <- TaskClassif$new(
id = "Classification original data",
backend = data.cluster,
target = "class",
positive = "fresh"
)
task$col_roles$stratum <- "class"
methods <- c("anova", "auc", "importance", "information_gain")
tab <- as.data.frame(lapply(methods, function(i) feature_selection(task, i)))
tab$auc <- round(tab$auc + 0.5, 4)
cor.data <- data.analysis |> dplyr::select(!c(sample, class))
corr_Kvalue <- cor(cor.data)["K value",]
top.cor <- sort(abs(corr_Kvalue), decreasing = TRUE)
(top.cor <- head(top.cor, 10))
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster <- bind_cols(data.cluster, class = data.analysis$class)
task <- TaskClassif$new(
id = "Classification original data",
backend = data.cluster,
target = "class",
positive = "fresh"
)
task$col_roles$stratum <- "class"
methods <- c("anova", "auc", "importance", "information_gain")
tab <- as.data.frame(lapply(methods, function(i) feature_selection(task, i)))
colnames(tab) <- methods
head(tab)
plot_spectral_comparison <- function(raw_data, smoothed_data, n_samples = 5, out_dir = "plot/", save = TRUE) {
# Assertions
assertDataFrame(raw_data)
assertDataFrame(smoothed_data)
assertString(out_dir)
assertFlag(save)
# Random selecting rows
set.seed(123)
sample_ids <- sample(seq_len(nrow(raw_data)), n_samples)
# Add an ID column and pivot both to long format
prepare_long <- function(df, type_label) {
df |> mutate(sample_id = as.factor(row_number())) |>
filter(sample_id %in% sample_ids) |>
pivot_longer(cols = -sample_id, names_to = "wavelength", values_to = "intensity") |>
mutate(wavelength = wavelength, type = type_label)
}
df_raw <- prepare_long(raw_data, "raw")
df_smooth <- prepare_long(smoothed_data, "smoothed")
# Combine datasets
df_plot <- bind_rows(df_raw, df_smooth)
# Create the plot
p <- ggplot(df_plot, aes(x = wavelength, y = intensity, color = type, alpha = type)) +
geom_line(aes(group = interaction(sample_id, type)), size = 0.8) +
facet_wrap(~sample_id, scales = "free_y") +
scale_alpha_manual(values = c("raw" = 0.4, "smoothed" = 1)) +
scale_color_manual(values = c("raw" = "#003366", "smoothed" = "#9B1B30")) +
labs(
title = "Spectral Smoothing Comparison (Savitzky-Golay)",
subtitle = paste("Showing", n_samples, "randomly selected spectra"),
x = "wavelength / wavenumber",
y = "absorbance / intensity",
color = "data state",
alpha = "data state"
) +
theme_minimal() +
theme(
axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
panel.grid.major = element_line(color = "lightgray", linewidth = 0.5),
panel.grid.minor = element_blank())
if (save) {
filename <- "Spectral Smoothing Comparison"
ggsave(
filename = file.path(out_dir, filename),
plot = p,
width = 12,
height = 6,
dpi = 300
)
}
invisible(p)
}
source("settings.R")
source("source_all.R")
if (!file.exists("data/intermediate/data analysis.rds")) {
build_data_main()
}
data.analysis <- readRDS("data/intermediate/data analysis.rds")
knitr::include_graphics("plot/densities1.png")
knitr::include_graphics("plot/densities2.png")
knitr::include_graphics("plot/imputation_7_K value.png")
data.imputed <- readRDS("data/intermediate/data imputated.rds")
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster.smooth <- smoothing(data.cluster)
plot_spectral_comparison(data.cluster, data.cluster.smooth)
data.cluster.smooth <- bind_cols(data.cluster.smooth, class = data.analysis$class)
source("~/Desktop/NIR/code/plot.R")
source("settings.R")
source("source_all.R")
if (!file.exists("data/intermediate/data analysis.rds")) {
build_data_main()
}
data.analysis <- readRDS("data/intermediate/data analysis.rds")
knitr::include_graphics("plot/densities1.png")
knitr::include_graphics("plot/densities2.png")
knitr::include_graphics("plot/imputation_7_K value.png")
data.imputed <- readRDS("data/intermediate/data imputated.rds")
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster.smooth <- smoothing(data.cluster)
plot_spectral_comparison(data.cluster, data.cluster.smooth)
data.cluster.smooth <- bind_cols(data.cluster.smooth, class = data.analysis$class)
source("~/Desktop/NIR/code/plot.R")
source("settings.R")
source("source_all.R")
if (!file.exists("data/intermediate/data analysis.rds")) {
build_data_main()
}
data.analysis <- readRDS("data/intermediate/data analysis.rds")
knitr::include_graphics("plot/densities1.png")
knitr::include_graphics("plot/densities2.png")
knitr::include_graphics("plot/imputation_7_K value.png")
data.imputed <- readRDS("data/intermediate/data imputated.rds")
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster.smooth <- smoothing(data.cluster)
plot_spectral_comparison(data.cluster, data.cluster.smooth)
source("settings.R")
source("source_all.R")
if (!file.exists("data/intermediate/data analysis.rds")) {
build_data_main()
}
data.analysis <- readRDS("data/intermediate/data analysis.rds")
knitr::include_graphics("plot/densities1.png")
knitr::include_graphics("plot/densities2.png")
knitr::include_graphics("plot/imputation_7_K value.png")
data.imputed <- readRDS("data/intermediate/data imputated.rds")
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster.smooth <- smoothing(data.cluster)
plot_spectral_comparison(data.cluster, data.cluster.smooth)
source("settings.R")
source("source_all.R")
if (!file.exists("data/intermediate/data analysis.rds")) {
build_data_main()
}
data.analysis <- readRDS("data/intermediate/data analysis.rds")
knitr::include_graphics("plot/densities1.png")
knitr::include_graphics("plot/densities2.png")
knitr::include_graphics("plot/imputation_7_K value.png")
data.imputed <- readRDS("data/intermediate/data imputated.rds")
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster.smooth <- smoothing(data.cluster)
plot_spectral_comparison(data.cluster, data.cluster.smooth)
data.cluster.smooth <- bind_cols(data.cluster.smooth, class = data.analysis$class)
source("settings.R")
source("source_all.R")
if (!file.exists("data/intermediate/data analysis.rds")) {
build_data_main()
}
data.analysis <- readRDS("data/intermediate/data analysis.rds")
knitr::include_graphics("plot/densities1.png")
knitr::include_graphics("plot/densities2.png")
knitr::include_graphics("plot/imputation_7_K value.png")
data.imputed <- readRDS("data/intermediate/data imputated.rds")
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster.smooth <- smoothing(data.cluster)
plot_spectral_comparison(data.cluster, data.cluster.smooth)
data.cluster.smooth <- bind_cols(data.cluster.smooth, class = data.analysis$class)
source("settings.R")
source("source_all.R")
if (!file.exists("data/intermediate/data analysis.rds")) {
build_data_main()
}
data.analysis <- readRDS("data/intermediate/data analysis.rds")
knitr::include_graphics("plot/densities1.png")
knitr::include_graphics("plot/densities2.png")
knitr::include_graphics("plot/imputation_7_K value.png")
data.imputed <- readRDS("data/intermediate/data imputated.rds")
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster.smooth <- smoothing(data.cluster)
plot_spectral_comparison(data.cluster, data.cluster.smooth)
data.cluster.smooth <- bind_cols(data.cluster.smooth, class = data.analysis$class)
source("settings.R")
source("source_all.R")
if (!file.exists("data/intermediate/data analysis.rds")) {
build_data_main()
}
data.analysis <- readRDS("data/intermediate/data analysis.rds")
knitr::include_graphics("plot/densities1.png")
knitr::include_graphics("plot/densities2.png")
knitr::include_graphics("plot/imputation_7_K value.png")
data.imputed <- readRDS("data/intermediate/data imputated.rds")
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster.smooth <- smoothing(data.cluster)
plot_spectral_comparison(data.cluster, data.cluster.smooth)
data.cluster.smooth <- bind_cols(data.cluster.smooth, class = data.analysis$class)
source("settings.R")
source("source_all.R")
if (!file.exists("data/intermediate/data analysis.rds")) {
build_data_main()
}
data.analysis <- readRDS("data/intermediate/data analysis.rds")
knitr::include_graphics("plot/densities1.png")
knitr::include_graphics("plot/densities2.png")
knitr::include_graphics("plot/imputation_7_K value.png")
data.imputed <- readRDS("data/intermediate/data imputated.rds")
data.cluster <- data.analysis |> dplyr::select(grep("^[[:digit:]]*$", colnames(data.analysis), value = TRUE))
colnames(data.cluster) <- paste0("V", colnames(data.cluster))
data.cluster.smooth <- smoothing(data.cluster)
plot_spectral_comparison(data.cluster, data.cluster.smooth)
data.cluster.smooth <- bind_cols(data.cluster.smooth, class = data.analysis$class)
